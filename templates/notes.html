{% extends 'base.html' %}

{% block title %}My Notes - Smart Productivity Hub{% endblock %}
{% block page_title %}All My Notes{% endblock %}

{% block head %}
    {{ super() }}
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEbFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-blue: #0d6efd;
            --background-dark: #2c3e50;
            --card-background: #ffffff;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --shadow-strong: rgba(0, 0, 0, 0.2);
            --border-radius-card: 1rem;
            --border-radius-input: 0.75rem;
            --text-dark: #212529;
            --text-muted: #6c757d;
            --primary-accent: #007bff;
            --danger-accent: #dc3545;
            --hover-lift: translateY(-3px);
            --focus-glow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);

            /* Custom variables for button colors */
            --button-grey: #6c757d; /* Standard Bootstrap secondary color */
            --button-grey-hover: #5a6268; /* Darker grey on hover */
            --button-green: #28a745; /* Standard Bootstrap success color */
            --button-green-hover: #218838; /* Darker green on hover */
        }

        body {
            background: #f0f2f5;
            margin-top: 20px;
            font-family: 'Poppins', sans-serif;
            color: var(--text-dark);
        }

        .note-has-grid .single-note-item .card {
            border-radius: var(--border-radius-card);
            box-shadow: 0 8px 20px var(--shadow-medium);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border: none;
        }

        .note-has-grid .single-note-item .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px var(--shadow-strong);
        }

        .note-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-date {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .note-inner-content {
            font-size: 0.95rem;
            color: #495057;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 1rem;
        }

        /* The main actions group, now for favorite icon and buttons */
        .note-actions-group {
            display: flex;
            align-items: center;
            gap: 10px; /* Gap between the elements */
            padding-top: 10px;
            border-top: 1px solid #eee;
            margin-top: auto;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: flex-end; /* Align buttons to the right */
        }
        
        /* Ensure the favourite star is always on the left */
        .note-actions-group .favourite-note {
            margin-right: auto; /* Pushes the favorite icon to the far left */
        }


        .action-icon {
            font-size: 1.1rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
        }

        .action-icon:hover {
            color: var(--primary-accent);
        }
        .action-icon.text-warning.favourite-note {
            color: #ffc107;
        }
        .action-icon.text-warning.favourite-note:hover {
            color: #e0a800;
        }

        /* --- Button Styling --- */
        /* Base styling for all note action buttons to make them consistent */
        .note-action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem; /* Rounded corners */
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Shadow */
            cursor: pointer;
            border: none;
            /* Reset specific original styles that might conflict */
            margin-left: 0 !important; /* Crucial: Override any inherited margin-left */
        }

        /* Edit and Delete buttons (Grey color) */
        .note-action-edit-btn,
        .note-action-delete-btn {
            background-color: var(--button-grey); /* Grey background */
            color: #fff !important; /* White text */
        }

        .note-action-edit-btn:hover,
        .note-action-delete-btn:hover {
            background-color: var(--button-grey-hover); /* Darker grey on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        /* Summarize button (Light Green color) */
        .note-action-summarize-btn {
            background-color: #8fbc8f ; /* Light green background */
            color: seagreen; !important;
            border: 2px solid var(--button-green);
            padding: 0.5rem 1.2rem;
            border-radius: 0.75rem; /* Slightly more rounded for distinction */
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Consistent shadow */
        }

        .note-action-summarize-btn:hover {
            background-color: #8fbc8f ; /* Darker green on hover */
            border-color: var(--button-green-hover);
            transform: scale(1.03);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        /* Icon spacing within buttons */
        .note-action-btn i {
            margin-right: 0.5em; /* Space between icon and text */
        }
        
        /* Disabled state for summarize button */
        .note-action-summarize-btn:disabled {
            background-color: #8fbc8f ;
            border-color: #6c757d;
            box-shadow: none;
            text-shadow: none;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        /* Add Notes button style */
        #add-notes {
            font-size: 1rem;
            font-weight: 600;
            background-color: #1a73e8;
            color: #fff;
            padding: 0.6rem 1.8rem;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.3);
            transition: all 0.3s ease-in-out;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
        }

        #add-notes:hover {
            background-color: #155bb5;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(26, 115, 232, 0.4);
        }
        #add-notes i {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }

        /* Styles for the summary output directly below the note */
        .note-summary-output {
            background-color: #e9f5ff;
            border-left: 5px solid var(--primary-accent);
            padding: 1.2rem;
            margin-top: 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            color: #343a40;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            transition: all 0.3s ease-in-out;
        }
        /* Style for the loading spinner within the summary output */
        .note-summary-output .loading-spinner {
            display: inline-block;
            width: 25px;
            height: 25px;
            border: 4px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: var(--primary-accent);
            animation: spin 1s ease-in-out infinite;
            -webkit-animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (min-width: 992px) {
            .note-has-grid .single-note-item {
                max-width: 50%;
            }
        }

        @media (max-width: 991.98px) {
            .note-has-grid .single-note-item {
                max-width: 100%;
            }
        }

        @media (max-width: 767.98px) {
            .note-has-grid .single-note-item {
                max-width: 100%;
            }
            .note-actions-group {
                flex-wrap: wrap;
                justify-content: flex-start; /* Align to left on small screens */
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="page-content container note-has-grid">
    <div class="d-flex justify-content-end mb-3">
        <a href="{{ url_for('add_note') }}" id="add-notes" class="btn d-flex align-items-center gap-2">
            <i class="bi bi-plus-circle-fill fs-5"></i>
            <span>Add Notes</span>
        </a>
    </div>

    <div class="row">
        {% if all_notes %}
            {% for note in all_notes %}
                <div class="col-md-6 mb-4 single-note-item {% if note.is_favourite %}note-favourite{% endif %}" 
                     data-note-id="{{ note.id }}" 
                     data-note-content="{{ note.content | e }}"> 
                    <div class="card card-body h-100 d-flex flex-column">
                        <h5 class="note-title" data-noteHeading="{{ note.title }}">
                            {{ note.title }}
                            <i class="bi bi-circle-fill text-primary ms-2" style="font-size: 0.5rem;"></i>
                        </h5>
                        <p class="note-date">{{ note.timestamp.strftime('%d %B %Y') }}</p>
                        <div class="note-content">
                            <p class="note-inner-content" data-noteContent="{{ note.content }}">
                                {{ note.content }}
                            </p>
                        </div>
                        
                        {# This is the main action group containing the favorite icon and the buttons #}
                        <div class="note-actions-group mt-auto">
                            {# Favorite star icon #}
                            <span class="action-icon favourite-note {% if note.is_favourite %}text-warning{% endif %}" 
                                  onclick="favouriteNoteToggle({{ note.id }})" title="Toggle Favorite">
                                <i class="fa fa-star"></i>
                            </span>

                            {# Edit Button - now correctly styled like delete #}
                            <a href="{{ url_for('edit_note', note_id=note.id) }}" class="note-action-btn note-action-edit-btn">
                                <i class="fas fa-pencil-alt"></i> Edit
                            </a>

                            {# Delete Button - now a button element and correctly styled #}
                            <button type="button" class="note-action-btn note-action-delete-btn" 
                                    onclick="removeNoteConfirmation({{ note.id }})">
                                <i class="fas fa-trash"></i> Delete
                            </button>

                            {# Summarize Button - correctly styled with green #}
                            <button type="button" class="note-action-btn note-action-summarize-btn" 
                                    onclick="summarizeNote('{{ note.id }}', this)">
                                <i class="fas fa-robot"></i> Summarize
                            </button>
                        </div>
                        
                        {# Summary output div #}
                        <div class="note-summary-output mt-3" id="summary-output-{{ note.id }}" style="display: none;">
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center text-muted py-4">
                <p>No notes found. Click "Add Notes" to create your first note!</p>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function removeNoteConfirmation(noteId) {
        const noteItem = $(`[data-note-id="${noteId}"]`);
        if (!noteItem.length) {
            console.error('Note item not found for deletion:', noteId);
            return;
        }

        if (confirm('Are you sure you want to delete this note?')) {
            fetch(`/delete_note/${noteId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (response.headers.get('content-type')?.includes('application/json')) {
                    return response.json();
                }
                if (response.redirected) {
                    return { success: true };
                }
                return response.text().then(text => { throw new Error(text); });
            })
            .then(data => {
                if (data.success) {
                    noteItem.remove();
                    console.log(`Note ${noteId} deleted successfully.`);
                } else {
                    alert('Failed to delete note: ' + (data.message || 'Unknown error.'));
                }
            })
            .catch(error => {
                console.error('Error deleting note:', error);
                alert('An error occurred while deleting the note. Please check the console for details.');
            });
        }
    }

    function favouriteNoteToggle(noteId) {
        const noteItem = $(`[data-note-id="${noteId}"]`);
        if (!noteItem.length) {
            console.error('Note item not found for favouriting:', noteId);
            return;
        }
        const favouriteIcon = noteItem.find('.favourite-note .fa-star');
        const isFavourited = noteItem.hasClass('note-favourite');

        fetch(`/toggle_favourite_note/${noteId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ is_favourite: !isFavourited }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                noteItem.toggleClass('note-favourite');
                favouriteIcon.toggleClass('text-warning', !isFavourited);
                console.log(`Note ${noteId} favourite status toggled.`);
            } else {
                alert('Failed to update favourite status: ' + (data.message || 'Unknown error.'));
            }
        })
        .catch(error => {
            console.error('Error toggling favourite status:', error);
            alert('An error occurred while toggling favourite status. (Is backend route implemented?)');
        });
    }

     async function summarizeNote(noteId, summaryButton) { 
        console.log(`Summarize button clicked for note ID: ${noteId}`);
        
        const noteItem = summaryButton.closest('.single-note-item');
        if (!noteItem) {
            console.error("Could not find parent .single-note-item for button.");
            return;
        }
        const noteContent = noteItem.dataset.noteContent; 

        if (!noteContent || noteContent.trim() === '') {
            console.warn(`No content found for note ID: ${noteId}. Cannot summarize empty note.`);
            const summaryOutputDiv = document.getElementById(`summary-output-${noteId}`);
            summaryOutputDiv.innerHTML = `<div class="alert alert-info" role="alert">Note content is empty, nothing to summarize.</div>`;
            summaryOutputDiv.style.display = 'block';
            return; 
        }

        console.log(`Note content to summarize (first 100 chars): "${noteContent.substring(0, 100)}..."`); 

        const summaryOutputDiv = document.getElementById(`summary-output-${noteId}`);
        
        summaryOutputDiv.innerHTML = `
            <div class="text-center">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted">Generating summary...</p>
            </div>
        `;
        summaryOutputDiv.style.display = 'block';

        summaryButton.disabled = true;

        try {
            const response = await fetch('/api/summarize_note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content: noteContent }),
            });

            console.log("Fetch response received:", response);

            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                const data = await response.json();
                console.log("JSON data received:", data);

                if (response.ok) {
                    const summaryText = data.summary;
                    // Prepend your desired introductory text and add a line break
                    summaryOutputDiv.innerHTML = `Here is a concise summary of the text with key points highlighted:<br><br>${summaryText}`; 
                    
                    summaryOutputDiv.style.display = 'block';
                    console.log("Summary displayed successfully.");
                } else {
                    summaryOutputDiv.innerHTML = `<div class="alert alert-danger" role="alert">Error: ${data.error || 'Failed to get summary from AI service.'}</div>`;
                    summaryOutputDiv.style.display = 'block';
                    console.error("Server error response:", data.error);
                }
            } else {
                const textError = await response.text();
                summaryOutputDiv.innerHTML = `<div class="alert alert-danger" role="alert">Unexpected response from server: ${textError}</div>`;
                summaryOutputDiv.style.display = 'block';
                console.error("Non-JSON response from server:", textError);
            }
        } catch (error) {
            console.error('Error fetching summary:', error);
            summaryOutputDiv.innerHTML = `<div class="alert alert-danger" role="alert">An unexpected network error occurred: ${error.message}</div>`;
            summaryOutputDiv.style.display = 'block';
        } finally {
            summaryButton.disabled = false;
            console.log("Summarize button re-enabled.");
        }
    }


    
</script>
{% endblock %}