{% extends 'base.html' %}

{% block title %}Dashboard - Smart Productivity Hub{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEbFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .list-group-item {
            border-color: rgba(0,0,0,.05);
            padding: 1rem 1.5rem;
        }
        .priority-tag {
            padding: .25em .6em;
            border-radius: .25rem;
            font-size: .75em;
            font-weight: 700;
            text-transform: uppercase;
            color: white;
        }
        .priority-tag.high {
            background-color: #dc3545; /* Red */
        }
        .priority-tag.normal {
            background-color: #6c757d; /* Grey */
        }
        .priority-tag.low {
            background-color: #17a2b8; /* Cyan/Info */
        }
        .progress {
            height: 25px;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            font-weight: 600;
            line-height: 25px;
            color: white;
        }

        /* Styles for hidden notes - ESSENTIAL FOR "SEE MORE" */
        .note-item.hidden {
            display: none !important; /* Added !important for stronger override */
        }
        
        /* Style for the favorite star icon */
        .note-actions-group .action-icon {
            font-size: 1.1rem;
            cursor: pointer;
            color: #6c757d; /* Default muted color */
            transition: color 0.2s;
        }

        .note-actions-group .action-icon:hover {
            color: #0d6efd; /* Primary blue on hover */
        }
        
        .note-actions-group .action-icon.text-warning {
            color: #ffc107; /* Yellow for favorited */
        }
        .note-actions-group .action-icon.text-warning:hover {
            color: #e0a800; /* Darker yellow on hover for favorited */
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-7 mb-4">
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">Today's Tasks</div>
                        <div class="card-body p-0">
                            {% if todays_tasks %}
                                <ul class="list-group list-group-flush">
                                    {% for task in todays_tasks %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <input class="form-check-input me-3" type="checkbox" {% if task.is_completed %}checked{% endif %}
                                                onchange="toggleTaskCompletion({{ task.id }}, this.checked)">
                                                <label class="form-check-label mb-0 {% if task.is_completed %}text-decoration-line-through text-muted{% endif %}">
                                                    {{ task.title }}
                                                </label>
                                            </div>
                                            <span class="priority-tag {{ task.priority|lower }}">{{ task.priority }}</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted text-center py-3">No tasks due today.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">Upcoming Tasks</div>
                        <div class="card-body p-0">
                            {% if upcoming_tasks %}
                                <ul class="list-group list-group-flush">
                                    {% for task in upcoming_tasks %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <input class="form-check-input me-3" type="checkbox" {% if task.is_completed %}checked{% endif %}
                                                onchange="toggleTaskCompletion({{ task.id }}, this.checked)">
                                                <label class="form-check-label mb-0 {% if task.is_completed %}text-decoration-line-through text-muted{% endif %}">
                                                    {{ task.title }}
                                                </label>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-light text-dark me-2">{{ task.due_date.strftime('%b %d') }}</span>
                                                <span class="priority-tag {{ task.priority|lower }}">{{ task.priority }}</span>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted text-center py-3">No upcoming tasks.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5 mb-4">
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">Task Completion</div>
                        <div class="card-body">
                            <div class="progress" role="progressbar" aria-label="Task Completion"
                                 aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar bg-primary" style="width: {{ progress }}%">{{ progress }}%</div>
                            </div>
                            <p class="card-text mt-3 text-muted text-center"><small>Keep up the great work!</small></p>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card">
                        <div class="card-header">Notes</div>
                        <div class="card-body p-0">
                            {% if upcoming_notes %}
                                <ul class="list-group list-group-flush" id="notes-list">
                                    {% for note in upcoming_notes %}
                                        {# All note items are rendered without 'hidden' class by Jinja #}
                                        <li class="list-group-item note-item" data-note-id="{{ note.id }}">
                                            <div class="d-flex flex-column">
                                                <h5 class="card-title mb-1 fw-semibold">{{ note.title }}</h5>
                                                <p class="mb-2 text-muted">{{ note.content }}</p>
                                                <div class="note-actions-group mt-2">
                                                    <span class="action-icon favourite-note" onclick="favouriteNoteDashboard({{ note.id }})">
                                                        <i class="fa fa-star {% if note.is_favourite %}text-warning{% endif %}"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                                {% if upcoming_notes|length > 4 %}
                                    <div class="text-center py-3" id="see-more-container">
                                        <button id="see-more-notes" class="btn btn-primary btn-sm">See More</button>
                                    </div>
                                {% endif %}
                            {% else %}
                                <p class="text-muted text-center py-3">No Notes.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> </div> {% endblock %}

{% block scripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Handles deleting a note via AJAX on the Dashboard (function kept, but not called by a button in HTML)
    function removeNoteDashboard(noteId) {
        const noteItem = document.querySelector(`[data-note-id="${noteId}"]`);
        if (!noteItem) {
            console.error('Note item not found for deletion:', noteId);
            return;
        }

        if (confirm('Are you sure you want to delete this note?')) {
            fetch(`/delete_note/${noteId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    noteItem.remove(); // Remove note from the DOM
                    console.log(`Note ${noteId} deleted successfully from dashboard.`);
                    // Optionally, you might want to re-run updateNoteVisibility() here
                    // to adjust the "See More" button and potentially the display if the count changes
                    const notesList = document.getElementById('notes-list');
                    const noteItemsAfterDelete = notesList ? notesList.querySelectorAll('.note-item') : [];
                    // Adjust visibleNotesCount if the deleted item was within the currently visible set
                    // This is a more advanced handling, for now, a simple reload is fine or just let it be.
                    // For a seamless experience, you'd re-call updateNoteVisibility() after removal
                    // and potentially adjust visibleNotesCount if a visible item was deleted.
                    // For simplicity, if you reintroduce a delete button, a page reload after delete is often acceptable.
                } else {
                    alert('Failed to delete note: ' + (data.message || 'Unknown error.'));
                }
            })
            .catch(error => {
                console.error('Error deleting note:', error);
                alert('An error occurred while deleting the note.');
            });
        }
    }

    // Handles toggling favourite status via AJAX on the Dashboard
    function favouriteNoteDashboard(noteId) {
        const noteItem = document.querySelector(`.note-item[data-note-id="${noteId}"]`);
        if (!noteItem) {
            console.error('Note item not found for favouriting:', noteId);
            return;
        }
        const favouriteIcon = noteItem.querySelector('.favourite-note .fa-star');
        const isFavourited = favouriteIcon.classList.contains('text-warning');

        fetch(`/toggle_favourite_note/${noteId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ is_favourite: !isFavourited }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                favouriteIcon.classList.toggle('text-warning');
                console.log(`Note ${noteId} favourite status toggled on dashboard.`);
            } else {
                alert('Failed to update favourite status: ' + (data.message || 'Unknown error.'));
            }
        })
        .catch(error => {
            console.error('Error toggling favourite status:', error);
            alert('An error occurred while toggling favourite status.');
        });
    }

    // Function to toggle task completion (from your provided dashboard script)
    function toggleTaskCompletion(taskId, isCompleted) {
        fetch(`/update_task_completion/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_completed: isCompleted })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert(data.message || 'Failed to update task.');
            } else {
                location.reload(); // Reload to reflect completion and progress updates
            }
        })
        .catch(error => {
            alert('Error updating task completion.');
        });
    }

    // Script to handle "See More" for notes
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded fired.");
        const notesList = document.getElementById('notes-list');
        const seeMoreButton = document.getElementById('see-more-notes');
        
        // Ensure notesList exists before querying its children
        const noteItems = notesList ? notesList.querySelectorAll('.note-item') : [];
        console.log("Found notesList:", notesList);
        console.log("Number of note items found:", noteItems.length);

        let visibleNotesCount = 4; // Initial number of visible notes

        function updateNoteVisibility() {
            console.log("Updating note visibility. Current visibleNotesCount:", visibleNotesCount);
            noteItems.forEach((item, index) => {
                if (index < visibleNotesCount) {
                    item.classList.remove('hidden'); // Show items within the visible count
                    // console.log(`Showing note at index ${index}`);
                } else {
                    item.classList.add('hidden');    // Hide items beyond the visible count
                    // console.log(`Hiding note at index ${index}`);
                }
            });

            if (seeMoreButton) {
                // If all notes are visible, hide the button
                if (visibleNotesCount >= noteItems.length) {
                    seeMoreButton.style.display = 'none';
                    console.log("Hiding 'See More' button.");
                } else {
                    seeMoreButton.style.display = 'block'; // Otherwise, ensure it's visible
                    console.log("Showing 'See More' button.");
                }
            } else {
                console.log("No 'See More' button found.");
            }
        }

        // Add event listener only if the button exists
        if (seeMoreButton) {
            seeMoreButton.addEventListener('click', function() {
                visibleNotesCount += 4; // Show next 4 notes
                updateNoteVisibility();
                console.log("See More clicked. New visibleNotesCount:", visibleNotesCount);
            });
        }

        // Initial update on page load to show the first 4 notes and hide the rest
        updateNoteVisibility();
    });
</script>
{% endblock %}